---
title: MySQL 负载均衡
date: 2020-04-11 17:21:46
tags: [MySQL]
categories: [数据库]
---


负载均衡的目的在于将流量平均的分发到集群中的机器。

<!--more-->

负载均衡的目的在于：

* 提高可扩展性：读写分离是从备库读取数据
* 高效性：可以把更多的工作分配给性能更好的机器
* 可用性：时刻都有可用的机器
* 透明性：客户端无感知负载方案
* 一致性：负载防止状态丢失，而无需应用去跟踪

![负载均衡经典架构](/load_balancing_architecture.png)

负载均衡通常与数据分片和复制相关， 需要关心的是读写策略， 一般来说有直接连接， 采用中间件以及一主多备间的负载均衡

# 直接连接

负载均衡并不只是配置在应用以及 MySQL 之间的东西，也可以直接连接到服务器。

## 复制上的读写分离

如何避免因为读写分离引起的脏数据的问题， 当一个用户进行了修改新增了一条评论， 但是刷新页面后却没有看到更新，这种通常都是因为从备库读取到了脏数据。

常见的读写分离的方法有：

基于查询分离

    将不能接受有脏数据的读写操作分配给主库， 始终保证数据是最新的。但是有很少的查询允许脏数据， 大多数的查询都分配给主库， 主从就没有意义了。
    
基于脏数据分离：
    
    让应用检查复制延迟，确认备库数据是否太旧。 很多报表类的应用都是晚上加载数据复制到备库即可，并不关心是否100%跟上了主库， 每晚更新一次。
    
基于会话分离：

    判断用户是否可以从备库读取数据的另一种方式： 先判断用户是否修改了数据。 用户只关心自己做的更新， 在会话层设置一个标记位，表明做了更新就将该用户的查询在一段时间内指向主库。
    
基于版本分离：
    
    跟踪对象的版本号以及时间戳， 如果备库的数据太旧，就从主库读取最新的数据。
    
 基于全局版本/会话分离：
 
    在应用执行写操作时，提交事务后执行一次 SHOW MASTER STATUS 操作，在缓存中存储主库日志坐标，作为被修改对象/会话的版本号， 连接从库时执行 SHOW SLAVE STATUS 并将备库的坐标与缓存中的版本号相对比， 如果备库的记录点和主库的不一致就读取主库数据。
    
## 修改应用的配置

应用的配置不要写死， 而是将配置存储在服务器或者缓存中， 这样更灵活。

## 修改 DNS 名称

 为不同服务器指定一个合适的名字， 为只读服务器分配一个 DNS 名， 为专门写操作的服务器起另外一个 DNS 名称。 如果备库能够跟上主库， 就将只读 DNS 名称指定给备库， 当出现延迟时， 再将 DNS 名指定给主库。
 
 这种修改 DNS 名称的技术很容易实现， 但是有很多缺点，最大的问题是无法控制 DNS。
 * 修改 DNS 并不是立马生效， 也不是原子操作。
 * DNS 数据会缓存， 且失效时间并不是强制的。
 * 可能需要应用或服务器重启才能使修改后的 DNS 完全生效。
 * 多个 IP 地址共用一个 DNS 名 并依赖轮询来均衡请求。
 
 所有通常不建议使用这种方式。
 
 ## 转移 IP 地址
 
 为每一个物理服务器分配一个固定的 IP 地址， 再为每个逻辑上的服务使用一个虚拟的 IP 地址。
 
 
 # 引入中间件
 
 之前讨论的方案是应用与 MySQL 直连， 实际上很多解决方案会引入中间件， 作为网络代理一边接受所有的通信请求， 另一边将这些请求派发到指定的机器上。 如图所示的解决方案
 
 ![负载均衡中间件](/load_balance_middle.png)
 
 ## 负载均衡器
 
 负载均衡器更多用在 WEB 服务商， 因为大多数的负载均衡器都支持HTTP， MySQL 的链接都是 TCP/IP 链接， 所以在 MySQL上使用多用途负载均衡器， 但是由于缺少 MySQL 专有的特性， 会有许多限制。
 
 * 除非负载均衡器知道 MySQL 的负载， 否则无法做到恨到的负载均衡。
 * 负载均衡器不知道如何把单个 HTTP 请求与 MySQL服务器绑定。
 * 连接池和长连接会阻碍负载均衡器分发请求。
 * MySQL不接受到 3306 端口的 HTTP 请求， 所以不能通过 HTTP 请求进行负载检查， 所以需要在 MySQL服务器额外安装一个 HTTP 服务器软件， 这个软件检查MySQL服务器的状态并返回一个对应的状态值。


## 负载均衡算法

随机： 从可用的服务池中选择一个服务器处理请求

轮询： 按照循环顺序发送请求到服务器。

最少连接数： 下一个请求分配给拥有最少活跃连接的服务器。

最快响应： 按照处理请求的响应时间分配请求。

哈希： 根据连接的源 IP 进行哈希， 映射到池中的同一服务器。

权重： 对应集群中有单核 CPU 与双核 CPU 时， 负载均衡器会分配两倍的请求给双 CPU 机器。

具体哪种算法更合适需要根据实际场景测试得出。

## 从服务器池中新增/移除服务器

新增的服务器可能未缓存数据， 第一次查询需要很长时间。 在通知负载均衡器有新机器加入之前可以暂时把查询映射到一台活跃的服务器上， 然后在新开启的服务器上读取和重放活跃服务器的日志文件， 或者捕捉生产服务器上的网络通信。

# 一主多备间的负载均衡

对于最常见的复制拓扑结构， 以下的方法可以更好的结合负载均衡。

功能分区：

    对于特定目的可以通过配置备库或一组备库来扩大容量。
    
过滤和数据分区：

    使用复制过滤技术对相似的备库进行分区例如将 A-M 开头的用户名的读操作分配给一个给定的备库， N-Z 开头的分配给另一个。
    
 将部分写操作转移到备库：
    
    分解写查询， 在备库执行一部分
    
 保证备库跟上主库：
 
    使用函数 MASTER_POS_WAIT() 阻塞直到备库赶上主库设置的同步点。
    
 同步写操作：
    
    每个备库轮流执行  MASTER_POS_WAIT()， 不到万不得已不要使用， 可能会阻塞很长时间。
    
选择合适的分片策略并不是说在应用设计初期就需要考虑分区分表， 做出来才是最重要的。 
    